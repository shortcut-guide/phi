---
import { useState } from "preact/hooks";
import { tw } from "tw-astasy";

const [file, setFile] = useState(null);
const [uploadStatus, setUploadStatus] = useState("");

const handleFileUpload = async () => {
    if (!file) {
        setUploadStatus("ファイルを選択してください。");
        return;
    }

    const reader = new FileReader();
    reader.onload = async (event) => {
        try {
            const jsonData = JSON.parse(event.target.result);

            const res = await fetch("/api/puppeteer/upload", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ json_data: jsonData }),
            });

            const result = await res.json();
            if (res.ok) {
                setUploadStatus("アップロード成功！");
            } else {
                setUploadStatus(`エラー: ${result.error}`);
            }
        } catch (error) {
            setUploadStatus("無効なJSONファイルです。");
        }
    };

    reader.readAsText(file);
};

const uploadContainer = tw`
  bg-white shadow-md p-6 rounded-md dark:bg-gray-800 w-full max-w-lg mx-auto
`;
const inputStyle = tw`
  formkit-input w-full border border-gray-300 rounded p-2 dark:bg-gray-700 dark:text-white
`;
const buttonStyle = tw`
  bg-purple-500 text-white px-4 py-2 rounded hover:bg-purple-700 transition w-full mt-4
`;
const statusStyle = tw`
  mt-4 text-center font-semibold text-red-500 dark:text-red-400
`;
---

<html>
    <head>
        <title>JSONアップロード</title>
    </head>
    <body class="bg-gray-100 dark:bg-gray-900 p-6 flex justify-center items-center min-h-screen">
        <div class={uploadContainer}>
            <h3 class="text-2xl font-bold mb-4 text-gray-800 dark:text-white">JSONファイルをアップロード</h3>
            <input class={inputStyle} type="file" accept=".json" onInput={(e) => setFile(e.target.files[0])} />
            <button class={buttonStyle} onClick={handleFileUpload}>アップロード</button>
            {uploadStatus && <p class={statusStyle}>{uploadStatus}</p>}
            <div class="mt-4 text-center">
                <a href="/list" class="text-blue-500 hover:underline">リストへ</a>
            </div>
        </div>
    </body>
</html>