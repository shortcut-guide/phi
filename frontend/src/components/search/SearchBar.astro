// frontend/src/components/search/SearchBar.astro
---
import { useState, useEffect } from 'react';
import { fetchSearchResults, fetchSuggestions } from '@/b/api/searchClient';
import { useSearchStore } from '@/b/stores/useSearchStore';

const [input, setInput] = useState('');
const [suggestions, setSuggestions] = useState<string[]>([]);
const { setResults, setHistory } = useSearchStore();

useEffect(() => {
  if (input.length >= 2) {
    fetchSuggestions(input).then(setSuggestions);
  }
}, [input]);

const handleSearch = async () => {
  const results = await fetchSearchResults(input);
  setResults(results);
  setHistory(input);
};

const handleSuggestionClick = async (keyword: string) => {
  setInput(keyword);
  const results = await fetchSearchResults(keyword);
  setResults(results);
  setHistory(keyword);
};
---
<div class="space-y-2 w-full">
  <input
    type="text"
    value={input}
    onInput={e => setInput(e.target.value)}
    onKeyDown={e => e.key === 'Enter' && handleSearch()}
    class="border p-2 w-full rounded"
    placeholder="商品名・カテゴリ・IDを検索"
  />
  {suggestions.length > 0 && (
    <ul class="bg-white border rounded shadow">
      {suggestions.map(s => (
        <li
          key={s}
          class="p-2 hover:bg-gray-100 cursor-pointer"
          onClick={() => handleSuggestionClick(s)}
        >{s}</li>
      ))}
    </ul>
  )}
</div>
